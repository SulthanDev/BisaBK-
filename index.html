<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bisaBK - Aplikasi Konseling Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .container-card {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        .main-content {
            min-height: 50vh;
        }
        .sidebar {
            background-color: #1e3a8a; /* Biru gelap untuk sidebar */
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .nav-button {
            transition: background-color 0.2s;
        }
        .nav-button:hover {
            background-color: #3b82f6;
        }
        .header-bg {
            background-color: #4f46e5; /* Ungu */
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #3730a3;
        }
        .input-style {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 768px) {
            .container-card {
                margin: 1rem;
                padding: 1rem;
            }
        }
    </style>
    <!-- FIX: Mengganti URL proyek Supabase dengan URL CDN library Supabase JS yang benar -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container-card">
    <header class="header-bg text-white p-4 rounded-t-xl shadow-lg">
        <h1 class="text-3xl font-bold">bisaBK | Aplikasi Konseling Digital</h1>
        <p class="mt-1">Layanan Bimbingan dan Konseling berbasis online</p>
    </header>

    <div id="app-container" class="mt-6">
        <!-- Konten aplikasi akan dirender di sini -->
    </div>

    <footer class="mt-8 pt-4 border-t text-center text-gray-500 text-sm">
        &copy; 2024 bisaBK - Layanan BK Digital.
    </footer>
</div>

<script>
    // --- KONFIGURASI SUPABASE (GANTI INI DENGAN KUNCI ASLI ANDA) ---
    // Ganti nilai placeholder ini dengan Project URL dan Anon Public Key dari Supabase Anda
    const SUPABASE_URL = 'https://lnizkypygqsqkukpwrxg.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxuaXpreXB5Z3FzcWt1a3B3cnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NTY4NTUsImV4cCI6MjA3NjAzMjg1NX0.dTO7Rn8ZIR9CVR3iah0ax3MZTDuD1Jvy8Wegdvc33pk'; 
    
    // FIX: Menggunakan window.supabase untuk mengakses objek global Supabase yang dimuat dari CDN.
    // Karena CDN di <head> sudah diperbaiki, baris ini seharusnya berfungsi.
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Kata sandi default untuk akun siswa baru atau hasil reset
    const DEFAULT_PASSWORD = '12346'; 

    // --- STATE GLOBAL ---
    let appState = {
        currentPage: 'login',
        user: null, // Berisi { username, role, displayName } jika sudah login
        currentRole: 'siswa', // 'siswa', 'guru', 'admin' - digunakan di halaman login
        accounts: [], // Data akun dari Supabase
        appointments: [], // Data janji temu dari Supabase
        materials: [], // Data materi dari Supabase
        logAudit: [], // Data log audit dari Supabase
        chatMessages: [], // Data chat lokal dari Supabase
        isDataLoaded: false,
    };

    // Helper untuk memuat data awal dari Supabase
    async function loadInitialData() {
        try {
            // 1. Load Semua Akun (untuk keperluan verifikasi login)
            const { data: accountsData, error: accountsError } = await supabase
                .from('accounts')
                .select('id, username, role, password, display_name');

            if (accountsError) throw accountsError;
            appState.accounts = accountsData;

            // 2. Load Janji Temu
            const { data: appointmentsData, error: appointmentsError } = await supabase
                .from('appointments')
                .select('*')
                .order('timestamp', { ascending: false });

            if (appointmentsError) throw appointmentsError;
            appState.appointments = appointmentsData;

            // 3. Load Materi
            const { data: materialsData, error: materialsError } = await supabase
                .from('materials')
                .select('*')
                .order('timestamp', { ascending: false });

            if (materialsError) throw materialsError;
            appState.materials = materialsData;
            
            // 4. Load Log Audit (Jika tabel log_audit ada, jika tidak, diabaikan)
            // Catatan: Jika tabel 'log_audit' belum dibuat di Supabase, bagian ini akan diabaikan.
            // Untuk kesederhanaan, kita akan menyimpan log audit di memori lokal untuk demo ini.
            
            appState.isDataLoaded = true;
            render();

        } catch (error) {
            console.error('Gagal memuat data awal dari Supabase:', error.message);
            displayMessage(`ERROR: Gagal memuat data. Periksa koneksi/kunci Supabase dan skema tabel. Detail: ${error.message}`, 'error');
        }
    }

    // PENGATURAN REALTIME DARI SUPABASE
    function setupRealtimeListeners() {
        // Listener untuk accounts (jika ada update oleh admin)
        supabase.channel('accounts')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'accounts' }, async () => {
                await loadInitialData();
            })
            .subscribe();

        // Listener untuk appointments (jika ada janji baru atau status diubah)
        supabase.channel('appointments')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'appointments' }, async () => {
                await loadInitialData();
            })
            .subscribe();

        // Listener untuk materials (jika admin/guru menambah materi)
        supabase.channel('materials')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'materials' }, async () => {
                await loadInitialData();
            })
            .subscribe();
            
        // Catatan: Karena kita tidak menggunakan fitur Auth Supabase, perubahan ini bersifat anonim, 
        // pastikan Anda sudah mengatur RLS Policy dengan benar (Anon/USING(true)) agar listener bekerja.
    }

    // --- UTILITY DAN AUTH ---

    function getLoggedInUser(username, password, role) {
        return appState.accounts.find(
            acc => acc.username.toLowerCase() === username.toLowerCase() && 
                   acc.password === password && 
                   acc.role === role
        );
    }

    function displayMessage(text, type = 'info') {
        const container = document.getElementById('app-container');
        if (!container) return;
        
        // Hapus pesan lama jika ada
        const existingMsg = document.getElementById('message-box');
        if (existingMsg) existingMsg.remove();

        const colorMap = {
            info: 'bg-blue-100 border-blue-400 text-blue-700',
            success: 'bg-green-100 border-green-400 text-green-700',
            error: 'bg-red-100 border-red-400 text-red-700'
        };

        const messageBox = document.createElement('div');
        messageBox.id = 'message-box';
        messageBox.className = `p-4 mb-4 border rounded-lg ${colorMap[type]}`;
        messageBox.innerHTML = `<strong>Pesan:</strong> ${text}`;
        
        container.prepend(messageBox);

        // Hapus pesan setelah 5 detik
        setTimeout(() => {
            if(messageBox) messageBox.remove();
        }, 5000);
    }

    function handleLogin() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const role = appState.currentRole;

        if (!username || !password) {
            displayMessage('Nama pengguna dan kata sandi harus diisi.', 'error');
            return;
        }

        const user = getLoggedInUser(username, password, role);

        if (user) {
            appState.user = user;
            appState.currentPage = user.role === 'siswa' ? 'siswa-home' : (user.role === 'guru' ? 'guru-home' : 'admin-home');
            displayMessage(`Selamat datang, ${user.display_name}!<br>Sandi default: ${DEFAULT_PASSWORD}`, 'success');
            render();
        } else {
            displayMessage('Login gagal. Periksa nama pengguna, kata sandi, dan peran yang Anda pilih.', 'error');
        }
    }
    
    // Fungsi untuk merender pesan error/sukses dari Supabase
    function handleSupabaseResponse(error, successMessage) {
        if (error) {
            console.error('Supabase Error:', error);
            displayMessage(`Gagal melakukan operasi: ${error.message}`, 'error');
            return false;
        }
        displayMessage(successMessage, 'success');
        return true;
    }

    // --- HANDLER SISWA ---

    function handleSiswaChangePassword() {
        const oldPass = document.getElementById('oldPassword').value;
        const newPass = document.getElementById('newPassword').value;

        if (oldPass !== appState.user.password) {
            displayMessage('Kata sandi lama salah.', 'error');
            return;
        }
        if (newPass.length < 5) {
            displayMessage('Kata sandi baru minimal 5 karakter.', 'error');
            return;
        }
        
        // Update di Supabase
        updatePasswordInSupabase(appState.user.username, newPass);
    }
    
    // HANDLER BARU: Siswa mereset sandi sendiri ke default
    async function handleSiswaSelfResetPassword() {
        if (!appState.user || appState.user.role !== 'siswa') {
            displayMessage('Aksi tidak valid. Anda harus masuk sebagai siswa.', 'error');
            return;
        }
        
        if (confirm(`Yakin ingin mereset kata sandi Anda sendiri (${appState.user.display_name}) ke sandi default: ${DEFAULT_PASSWORD}? Anda akan otomatis keluar.`)) {
            // Lakukan pembaruan sandi ke default
            await updatePasswordInSupabase(appState.user.username, DEFAULT_PASSWORD);

            // Force logout setelah self-reset untuk keamanan
            appState.user = null; 
            appState.currentPage = 'login'; 
            render();
            // Menampilkan pesan sukses setelah render agar pesan muncul di halaman login
            setTimeout(() => displayMessage(`Kata sandi Anda berhasil direset ke sandi default (${DEFAULT_PASSWORD}). Silakan masuk kembali.`, 'success'), 100);
        }
    }

    async function updatePasswordInSupabase(username, newPass) {
        try {
            const userToUpdate = appState.accounts.find(acc => acc.username.toLowerCase() === username.toLowerCase());
            if (!userToUpdate) {
                displayMessage(`Akun ${username} tidak ditemukan.`, 'error');
                return;
            }

            const { error } = await supabase
                .from('accounts')
                .update({ password: newPass })
                .eq('username', username);

            if (handleSupabaseResponse(error, `Kata sandi untuk ${username} berhasil diperbarui.`)) {
                // Update state lokal
                if (appState.user && appState.user.username === username) {
                    appState.user.password = newPass; 
                }
                // Segera refresh data dari Supabase untuk update akun di state global
                await loadInitialData();
                render();
            }
        } catch (e) {
            displayMessage(`Error saat memperbarui sandi: ${e.message}`, 'error');
        }
    }

    async function handleSiswaAppointmentSubmit() {
        const reason = document.getElementById('appointmentReason').value.trim();
        if (!reason) {
            displayMessage('Alasan janji temu harus diisi.', 'error');
            return;
        }

        const newAppointment = {
            siswa_name: appState.user.display_name,
            reason: reason,
            status: 'Pending',
        };

        const { error } = await supabase
            .from('appointments')
            .insert([newAppointment]);
        
        if (handleSupabaseResponse(error, 'Janji temu berhasil diajukan! Menunggu persetujuan Guru BK.')) {
            // Bersihkan input dan refresh data
            document.getElementById('appointmentReason').value = '';
            await loadInitialData();
            render();
        }
    }
    
    // Fungsi ini tidak lagi digunakan oleh halaman login
    function handleSiswaResetPassword() {
        displayMessage('Fitur reset sandi publik telah dipindahkan. Silakan gunakan opsi reset di portal Siswa atau hubungi Admin/Guru BK.', 'info');
    }


    // --- HANDLER GURU/ADMIN ---

    async function handleUpdateAppointmentStatus(id, newStatus) {
        const { error } = await supabase
            .from('appointments')
            .update({ status: newStatus })
            .eq('id', id);

        if (handleSupabaseResponse(error, `Status Janji Temu berhasil diubah menjadi ${newStatus}.`)) {
            await loadInitialData();
            render();
        }
    }

    async function handleAdminDeleteStudent(id) {
        const userToDelete = appState.accounts.find(acc => acc.id === id && acc.role === 'siswa');
        if (!userToDelete) return;

        if (confirm(`Yakin ingin menghapus akun siswa ${userToDelete.display_name} (${userToDelete.username})?`)) {
            const { error } = await supabase
                .from('accounts')
                .delete()
                .eq('id', id);

            if (handleSupabaseResponse(error, `Akun siswa ${userToDelete.display_name} berhasil dihapus.`)) {
                await loadInitialData();
                render();
            }
        }
    }
    
    async function handleAdminResetPassword(id) {
        const userToReset = appState.accounts.find(acc => acc.id === id && acc.role === 'siswa');
        if (!userToReset) return;

        // Tidak menggunakan confirm() karena sudah dilakukan di renderAdminUserManagement
        // if (confirm(`Yakin ingin mereset kata sandi akun siswa ${userToReset.display_name} (${userToReset.username})?`)) {
            updatePasswordInSupabase(userToReset.username, DEFAULT_PASSWORD);
        // }
    }
    
    async function handleAdminAddStudent() {
        const username = document.getElementById('newUsername').value.trim().toLowerCase();
        const displayName = document.getElementById('newDisplayName').value.trim();

        if (!username || !displayName) {
            displayMessage('Nama pengguna dan Nama Lengkap harus diisi.', 'error');
            return;
        }
        
        if (appState.accounts.some(acc => acc.username.toLowerCase() === username)) {
            displayMessage(`Nama pengguna '${username}' sudah digunakan.`, 'error');
            return;
        }

        const newUser = {
            username: username,
            role: 'siswa',
            password: DEFAULT_PASSWORD, // Sandi default
            display_name: displayName
        };

        const { error } = await supabase
            .from('accounts')
            .insert([newUser]);

        if (handleSupabaseResponse(error, `Akun Siswa ${displayName} berhasil ditambahkan dengan sandi default (${DEFAULT_PASSWORD}).`)) {
            document.getElementById('newUsername').value = '';
            document.getElementById('newDisplayName').value = '';
            await loadInitialData();
            render();
        }
    }


    async function handleGuruUploadMaterial() {
        const title = document.getElementById('materialTitle').value.trim();
        const content = document.getElementById('materialContent').value.trim();

        if (!title || !content) {
            displayMessage('Judul dan konten materi harus diisi.', 'error');
            return;
        }

        const newMaterial = {
            title: title,
            content: content,
        };

        const { error } = await supabase
            .from('materials')
            .insert([newMaterial]);
        
        if (handleSupabaseResponse(error, 'Materi inspirasi berhasil diunggah!')) {
            document.getElementById('materialTitle').value = '';
            document.getElementById('materialContent').value = '';
            await loadInitialData();
            render();
        }
    }


    // --- RENDERING VIEWS ---

    function renderLogin() {
        return `
            <div class="max-w-md mx-auto bg-gray-50 p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl font-semibold text-center mb-6 text-gray-800">Masuk ke Portal</h2>
                
                <div class="flex justify-center space-x-2 mb-6 p-1 bg-gray-200 rounded-full">
                    ${['siswa', 'guru', 'admin'].map(role => `
                        <button 
                            onclick="appState.currentRole='${role}'; render();"
                            class="flex-1 px-4 py-2 text-sm font-medium rounded-full nav-button capitalize transition ${appState.currentRole === role ? 'bg-indigo-600 text-white shadow-md' : 'bg-transparent text-gray-700 hover:bg-gray-300'}"
                        >
                            ${role === 'siswa' ? 'Siswa' : (role === 'guru' ? 'Guru BK' : 'Admin')}
                        </button>
                    `).join('')}
                </div>

                <div class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Nama Pengguna</label>
                        <input type="text" id="username" class="input-style mt-1" placeholder="Masukkan ID atau NIM Anda">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Kata Sandi</label>
                        <input type="password" id="password" class="input-style mt-1" placeholder="Kata Sandi">
                    </div>
                    
                    <button onclick="handleLogin()" class="btn-primary w-full mt-4 text-lg">
                        Masuk sebagai ${appState.currentRole === 'siswa' ? 'Siswa' : (appState.currentRole === 'guru' ? 'Guru BK' : 'Admin')}
                    </button>
                </div>

                <!-- UPDATE: Menghapus pesan Guru BK/Admin dapat mereset sandi -->
                <div class="mt-6 text-center text-sm text-gray-600">
                    <p>Lupa Kata Sandi? Silakan hubungi Guru BK atau Admin Anda.</p>
                </div>
            </div>
        `;
    }

    function renderSiswaHome() {
        const appointments = appState.appointments.filter(app => app.siswa_name === appState.user.display_name);

        return `
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Sidebar Navigasi -->
                <div class="sidebar md:col-span-1 p-4">
                    <h3 class="text-xl font-semibold mb-4">Portal Siswa</h3>
                    <p class="mb-6">Halo, ${appState.user.display_name}!</p>
                    <ul class="space-y-2">
                        <li><button onclick="appState.currentPage='siswa-home'; render();" class="nav-button w-full text-left p-2 rounded-md bg-indigo-700">Beranda & Janji Temu</button></li>
                        <li><button onclick="appState.currentPage='siswa-materi'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Materi Inspirasi</button></li>
                        <li><button onclick="appState.currentPage='siswa-profile'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Ubah Sandi</button></li>
                        <li><button onclick="appState.currentPage='chat'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Diskusi Kelompok (Chat)</button></li>
                        <li><button onclick="appState.user=null; appState.currentPage='login'; render();" class="nav-button w-full text-left p-2 rounded-md bg-red-600 hover:bg-red-700 mt-4">Keluar</button></li>
                    </ul>
                </div>
                
                <!-- Konten Utama: Pengajuan Janji Temu -->
                <div class="md:col-span-2 main-content space-y-8">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Pengajuan Janji Temu Konseling</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-indigo-200">
                        <textarea id="appointmentReason" rows="4" class="input-style" placeholder="Tuliskan alasan atau topik konseling Anda secara singkat (misal: sulit fokus belajar, masalah karir, dsb.)"></textarea>
                        <button onclick="handleSiswaAppointmentSubmit()" class="btn-primary w-full mt-3">Ajukan Janji Temu</button>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-700 mt-6 border-b pb-2">Riwayat Janji Temu Saya</h3>
                    <div class="space-y-4">
                        ${appointments.length === 0 
                            ? '<p class="text-gray-500">Belum ada riwayat janji temu yang diajukan.</p>' 
                            : appointments.map(app => `
                                <div class="p-4 rounded-lg border ${app.status === 'Accepted' ? 'bg-green-50 border-green-300' : (app.status === 'Rejected' ? 'bg-red-50 border-red-300' : 'bg-yellow-50 border-yellow-300')} shadow-sm">
                                    <p class="font-semibold">${app.reason}</p>
                                    <p class="text-sm text-gray-600">Status: 
                                        <span class="font-bold ${app.status === 'Accepted' ? 'text-green-600' : (app.status === 'Rejected' ? 'text-red-600' : 'text-yellow-600')}">
                                            ${app.status}
                                        </span>
                                    </p>
                                    <p class="text-xs text-gray-500">Diajukan: ${new Date(app.timestamp).toLocaleString('id-ID')}</p>
                                </div>
                            `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function renderSiswaMateri() {
        return `
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Sidebar Navigasi -->
                <div class="sidebar md:col-span-1 p-4">
                    <h3 class="text-xl font-semibold mb-4">Portal Siswa</h3>
                    <p class="mb-6">Halo, ${appState.user.display_name}!</p>
                    <ul class="space-y-2">
                        <li><button onclick="appState.currentPage='siswa-home'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Beranda & Janji Temu</button></li>
                        <li><button onclick="appState.currentPage='siswa-materi'; render();" class="nav-button w-full text-left p-2 rounded-md bg-indigo-700">Materi Inspirasi</button></li>
                        <li><button onclick="appState.currentPage='siswa-profile'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Ubah Sandi</button></li>
                        <li><button onclick="appState.currentPage='chat'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Diskusi Kelompok (Chat)</button></li>
                        <li><button onclick="appState.user=null; appState.currentPage='login'; render();" class="nav-button w-full text-left p-2 rounded-md bg-red-600 hover:bg-red-700 mt-4">Keluar</button></li>
                    </ul>
                </div>

                <!-- Konten Utama: Materi -->
                <div class="md:col-span-2 main-content space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Materi Inspirasi & Edukasi</h2>
                    <div class="space-y-4">
                        ${appState.materials.length === 0 
                            ? '<p class="text-gray-500">Belum ada materi inspirasi yang tersedia.</p>' 
                            : appState.materials.map(mat => `
                                <div class="p-5 rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow-md transition">
                                    <h4 class="text-xl font-semibold text-indigo-700">${mat.title}</h4>
                                    <p class="text-sm text-gray-500 mb-3">Diunggah: ${new Date(mat.timestamp).toLocaleDateString('id-ID')}</p>
                                    <p class="text-gray-700 whitespace-pre-line">${mat.content}</p>
                                </div>
                            `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function renderSiswaProfile() {
        return `
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Sidebar Navigasi -->
                <div class="sidebar md:col-span-1 p-4">
                    <h3 class="text-xl font-semibold mb-4">Portal Siswa</h3>
                    <p class="mb-6">Halo, ${appState.user.display_name}!</p>
                    <ul class="space-y-2">
                        <li><button onclick="appState.currentPage='siswa-home'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Beranda & Janji Temu</button></li>
                        <li><button onclick="appState.currentPage='siswa-materi'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Materi Inspirasi</button></li>
                        <li><button onclick="appState.currentPage='siswa-profile'; render();" class="nav-button w-full text-left p-2 rounded-md bg-indigo-700">Ubah Sandi</button></li>
                        <li><button onclick="appState.currentPage='chat'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Diskusi Kelompok (Chat)</button></li>
                        <li><button onclick="appState.user=null; appState.currentPage='login'; render();" class="nav-button w-full text-left p-2 rounded-md bg-red-600 hover:bg-red-700 mt-4">Keluar</button></li>
                    </ul>
                </div>

                <!-- Konten Utama: Ubah Sandi -->
                <div class="md:col-span-2 main-content space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Ubah Kata Sandi</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-indigo-200 max-w-lg">
                        <p class="mb-4 text-gray-600">Anda dapat mengubah kata sandi Anda di sini. Nama Pengguna: <strong>${appState.user.username}</strong></p>
                        <div class="space-y-3">
                            <div>
                                <label for="oldPassword" class="block text-sm font-medium text-gray-700">Kata Sandi Lama</label>
                                <input type="password" id="oldPassword" class="input-style mt-1">
                            </div>
                            <div>
                                <label for="newPassword" class="block text-sm font-medium text-gray-700">Kata Sandi Baru</label>
                                <input type="password" id="newPassword" class="input-style mt-1">
                            </div>
                            <button onclick="handleSiswaChangePassword()" class="btn-primary w-full mt-3">Perbarui Kata Sandi</button>
                        </div>
                    </div>

                    <!-- FITUR BARU: Reset Sandi Mandiri ke Default -->
                    <h3 class="text-2xl font-bold text-gray-800 border-b pb-2 mt-8">Reset Sandi Mandiri (Darurat)</h3>
                    <div class="bg-red-50 p-6 rounded-lg shadow-md border border-red-300 max-w-lg">
                        <p class="mb-3 text-sm text-red-700">Jika Anda lupa sandi kustom yang Anda buat, Anda dapat mereset sandi Anda sendiri kembali ke **sandi default**:</p>
                        <p class="text-lg font-bold text-red-800 mb-3">${DEFAULT_PASSWORD}</p>
                        <button onclick="handleSiswaSelfResetPassword()" class="bg-red-600 hover:bg-red-700 text-white w-full py-2 rounded-md transition">Reset Sandi Saya ke Default</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderGuruHome() {
        const pendingAppointments = appState.appointments.filter(app => app.status === 'Pending');
        const acceptedAppointments = appState.appointments.filter(app => app.status === 'Accepted');
        const totalAppointments = appState.appointments.length;

        return `
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Sidebar Navigasi -->
                <div class="sidebar md:col-span-1 p-4">
                    <h3 class="text-xl font-semibold mb-4">Portal Guru BK</h3>
                    <p class="mb-6">Halo, ${appState.user.display_name}!</p>
                    <ul class="space-y-2">
                        <li><button onclick="appState.currentPage='guru-home'; render();" class="nav-button w-full text-left p-2 rounded-md bg-indigo-700">Beranda & Janji Temu</button></li>
                        <li><button onclick="appState.currentPage='guru-materi-upload'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Unggah Materi</button></li>
                        <li><button onclick="appState.currentPage='chat'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Diskusi Kelompok (Chat)</button></li>
                        <li><button onclick="appState.user=null; appState.currentPage='login'; render();" class="nav-button w-full text-left p-2 rounded-md bg-red-600 hover:bg-red-700 mt-4">Keluar</button></li>
                    </ul>
                </div>
                
                <!-- Konten Utama: Janji Temu -->
                <div class="md:col-span-2 main-content space-y-8">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Manajemen Janji Temu</h2>
                    
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-indigo-100 p-4 rounded-lg shadow-md">
                            <p class="text-3xl font-bold text-indigo-700">${pendingAppointments.length}</p>
                            <p class="text-sm text-indigo-700">Janji Pending</p>
                        </div>
                         <div class="bg-green-100 p-4 rounded-lg shadow-md">
                            <p class="text-3xl font-bold text-green-700">${acceptedAppointments.length}</p>
                            <p class="text-sm text-green-700">Janji Disetujui</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg shadow-md">
                            <p class="text-3xl font-bold text-gray-700">${totalAppointments}</p>
                            <p class="text-sm text-gray-700">Total Janji</p>
                        </div>
                    </div>
                    
                    <!-- Janji Pending -->
                    <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mt-6">Janji Temu Menunggu Persetujuan</h3>
                    <div class="space-y-4">
                        ${pendingAppointments.length === 0 
                            ? '<p class="text-gray-500">Tidak ada janji temu yang menunggu persetujuan.</p>' 
                            : pendingAppointments.map(app => `
                                <div class="p-4 rounded-lg border border-yellow-300 bg-yellow-50 shadow-sm">
                                    <p class="font-semibold text-lg text-yellow-800">${app.siswa_name}</p>
                                    <p class="text-gray-700">Alasan: ${app.reason}</p>
                                    <p class="text-xs text-gray-500 mb-3">Diajukan: ${new Date(app.timestamp).toLocaleString('id-ID')}</p>
                                    <div class="mt-2 space-x-2">
                                        <button onclick="handleUpdateAppointmentStatus(${app.id}, 'Accepted')" class="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1 rounded-md">Setujui</button>
                                        <button onclick="handleUpdateAppointmentStatus(${app.id}, 'Rejected')" class="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1 rounded-md">Tolak</button>
                                    </div>
                                </div>
                            `).join('')}
                    </div>

                    <!-- Riwayat Janji Lain -->
                    <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mt-8">Riwayat Janji Temu Lainnya</h3>
                    <div class="space-y-4">
                         ${appState.appointments.filter(app => app.status !== 'Pending').map(app => `
                                <div class="p-4 rounded-lg border ${app.status === 'Accepted' ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'} shadow-sm">
                                    <p class="font-semibold">${app.siswa_name} - ${app.reason}</p>
                                    <p class="text-sm text-gray-600">Status: 
                                        <span class="font-bold ${app.status === 'Accepted' ? 'text-green-600' : 'text-red-600'}">
                                            ${app.status}
                                        </span>
                                    </p>
                                    <p class="text-xs text-gray-500">Tanggal: ${new Date(app.timestamp).toLocaleDateString('id-ID')}</p>
                                </div>
                            `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function renderGuruMateriUpload() {
        return `
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Sidebar Navigasi -->
                <div class="sidebar md:col-span-1 p-4">
                    <h3 class="text-xl font-semibold mb-4">Portal Guru BK</h3>
                    <p class="mb-6">Halo, ${appState.user.display_name}!</p>
                    <ul class="space-y-2">
                        <li><button onclick="appState.currentPage='guru-home'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Beranda & Janji Temu</button></li>
                        <li><button onclick="appState.currentPage='guru-materi-upload'; render();" class="nav-button w-full text-left p-2 rounded-md bg-indigo-700">Unggah Materi</button></li>
                        <li><button onclick="appState.currentPage='chat'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Diskusi Kelompok (Chat)</button></li>
                        <li><button onclick="appState.user=null; appState.currentPage='login'; render();" class="nav-button w-full text-left p-2 rounded-md bg-red-600 hover:bg-red-700 mt-4">Keluar</button></li>
                    </ul>
                </div>
                
                <!-- Konten Utama: Unggah Materi -->
                <div class="md:col-span-2 main-content space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Unggah Materi Inspirasi Baru</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-indigo-200">
                        <div class="space-y-4">
                            <div>
                                <label for="materialTitle" class="block text-sm font-medium text-gray-700">Judul Materi</label>
                                <input type="text" id="materialTitle" class="input-style mt-1" placeholder="Misal: 5 Tips Fokus Belajar">
                            </div>
                            <div>
                                <label for="materialContent" class="block text-sm font-medium text-gray-700">Isi Konten</label>
                                <textarea id="materialContent" rows="8" class="input-style mt-1" placeholder="Tuliskan isi materi di sini..."></textarea>
                            </div>
                            <button onclick="handleGuruUploadMaterial()" class="btn-primary w-full mt-3">Unggah Materi Sekarang</button>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-gray-700 mt-8 border-b pb-2">Materi yang Sudah Diunggah</h3>
                    ${appState.materials.length === 0 
                        ? '<p class="text-gray-500">Tidak ada materi yang sudah diunggah.</p>' 
                        : appState.materials.map(mat => `
                            <div class="p-3 rounded-lg border border-gray-200 bg-gray-50">
                                <h4 class="font-semibold">${mat.title}</h4>
                                <p class="text-xs text-gray-500">Diunggah: ${new Date(mat.timestamp).toLocaleDateString('id-ID')}</p>
                            </div>
                        `).join('')}
                </div>
            </div>
        `;
    }

    function renderAdminHome() {
        return `
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Sidebar Navigasi -->
                <div class="sidebar md:col-span-1 p-4">
                    <h3 class="text-xl font-semibold mb-4">Portal Admin</h3>
                    <p class="mb-6">Halo, ${appState.user.display_name}!</p>
                    <ul class="space-y-2">
                        <li><button onclick="appState.currentPage='admin-home'; render();" class="nav-button w-full text-left p-2 rounded-md bg-indigo-700">Dashboard</button></li>
                        <li><button onclick="appState.currentPage='admin-users'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Kelola Pengguna Siswa</button></li>
                        <li><button onclick="appState.user=null; appState.currentPage='login'; render();" class="nav-button w-full text-left p-2 rounded-md bg-red-600 hover:bg-red-700 mt-4">Keluar</button></li>
                    </ul>
                </div>
                
                <!-- Konten Utama: Dashboard -->
                <div class="md:col-span-2 main-content space-y-8">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Dashboard Admin</h2>
                    
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                            <p class="text-3xl font-bold text-blue-700">${appState.accounts.filter(a => a.role === 'siswa').length}</p>
                            <p class="text-sm text-blue-700">Total Siswa</p>
                        </div>
                         <div class="bg-indigo-100 p-4 rounded-lg shadow-md">
                            <p class="text-3xl font-bold text-indigo-700">${appState.accounts.filter(a => a.role === 'guru').length}</p>
                            <p class="text-sm text-indigo-700">Total Guru BK</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg shadow-md">
                            <p class="text-3xl font-bold text-gray-700">${appState.appointments.length}</p>
                            <p class="text-sm text-gray-700">Total Janji Temu</p>
                        </div>
                    </div>

                    <div class="p-4 bg-yellow-100 border border-yellow-300 rounded-lg">
                        <h3 class="font-semibold text-lg text-yellow-800">Peringatan Keamanan</h3>
                        <p class="text-sm text-yellow-800">Pastikan Anda telah mengaktifkan **Row Level Security (RLS)** dan mengatur **Policies** yang ketat di Supabase untuk mengamankan data pengguna!</p>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-700 mt-8 border-b pb-2">Log Audit (Contoh Lokal)</h3>
                    <div class="space-y-2 max-h-48 overflow-y-auto bg-gray-50 p-3 rounded-lg border">
                        ${appState.logAudit.length === 0 
                            ? '<p class="text-gray-500 text-sm">Belum ada aktivitas log (hanya mencatat log ubah/reset sandi).</p>' 
                            : appState.logAudit.map(log => `<p class="text-xs text-gray-700"><strong>[${log.timestamp}]</strong> ${log.action} oleh ${log.user}</p>`).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function renderAdminUserManagement() {
        const students = appState.accounts.filter(a => a.role === 'siswa');

        return `
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Sidebar Navigasi -->
                <div class="sidebar md:col-span-1 p-4">
                    <h3 class="text-xl font-semibold mb-4">Portal Admin</h3>
                    <p class="mb-6">Halo, ${appState.user.display_name}!</p>
                    <ul class="space-y-2">
                        <li><button onclick="appState.currentPage='admin-home'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Dashboard</button></li>
                        <li><button onclick="appState.currentPage='admin-users'; render();" class="nav-button w-full text-left p-2 rounded-md bg-indigo-700">Kelola Pengguna Siswa</button></li>
                        <li><button onclick="appState.user=null; appState.currentPage='login'; render();" class="nav-button w-full text-left p-2 rounded-md bg-red-600 hover:bg-red-700 mt-4">Keluar</button></li>
                    </ul>
                </div>
                
                <!-- Konten Utama: Kelola Pengguna -->
                <div class="md:col-span-2 main-content space-y-8">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Kelola Akun Siswa</h2>
                    
                    <!-- Form Tambah Akun Siswa Baru -->
                    <div class="bg-gray-100 p-6 rounded-lg shadow-inner border border-gray-300">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Tambah Akun Siswa Baru</h3>
                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="text" id="newDisplayName" class="input-style col-span-1" placeholder="Nama Lengkap Siswa">
                            <input type="text" id="newUsername" class="input-style col-span-1" placeholder="Nama Pengguna/ID Siswa">
                            <button onclick="handleAdminAddStudent()" class="btn-primary col-span-1">Tambahkan Akun</button>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Sandi default otomatis: ${DEFAULT_PASSWORD}</p>
                    </div>


                    <h3 class="text-xl font-semibold text-gray-700 mt-8 border-b pb-2">Daftar Siswa (${students.length} Akun)</h3>
                    <div class="space-y-4">
                        ${students.length === 0 
                            ? '<p class="text-gray-500">Tidak ada akun siswa terdaftar.</p>' 
                            : students.map(student => `
                                <div class="p-4 rounded-lg border border-indigo-200 bg-white shadow-sm flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold">${student.display_name} <span class="text-sm text-gray-500">(${student.username})</span></p>
                                        <p class="text-xs text-gray-400">ID Internal: ${student.id}</p>
                                    </div>
                                    <div class="space-x-2 flex">
                                        <button onclick="handleAdminResetPassword(${student.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm px-3 py-1 rounded-md">Reset Sandi</button>
                                        <button onclick="handleAdminDeleteStudent(${student.id})" class="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1 rounded-md">Hapus Akun</button>
                                    </div>
                                </div>
                            `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Placeholder for Chat functionality (using the same structure as other views)
    function renderChat() {
        const currentRoleText = appState.user.role === 'siswa' ? 'Siswa' : (appState.user.role === 'guru' ? 'Guru BK' : 'Admin');
        
        return `
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Sidebar Navigasi -->
                <div class="sidebar md:col-span-1 p-4">
                    <h3 class="text-xl font-semibold mb-4">Portal ${currentRoleText}</h3>
                    <p class="mb-6">Halo, ${appState.user.display_name}!</p>
                    <ul class="space-y-2">
                        <li><button onclick="appState.currentPage='${appState.user.role}-home'; render();" class="nav-button w-full text-left p-2 rounded-md hover:bg-indigo-700">Kembali ke Beranda</button></li>
                        <li><button onclick="appState.currentPage='chat'; render();" class="nav-button w-full text-left p-2 rounded-md bg-indigo-700">Diskusi Kelompok</button></li>
                        <li><button onclick="appState.user=null; appState.currentPage='login'; render();" class="nav-button w-full text-left p-2 rounded-md bg-red-600 hover:bg-red-700 mt-4">Keluar</button></li>
                    </ul>
                </div>

                <!-- Konten Utama: Chat -->
                <div class="md:col-span-2 main-content space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Diskusi Kelompok (Fitur Chat Lokal)</h2>
                    
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                        <p class="text-sm text-indigo-800">Fitur ini mensimulasikan diskusi kelompok Bimbingan dan Konseling. Untuk mengaktifkan Chat Realtime, diperlukan tabel Supabase tambahan untuk menyimpan pesan.</p>
                    </div>

                    <!-- Area Pesan (Placeholder untuk chat lokal) -->
                    <div id="chat-messages" class="bg-white p-4 h-96 overflow-y-scroll border border-gray-300 rounded-lg shadow-inner space-y-3">
                        ${appState.chatMessages.length === 0 
                            ? '<p class="text-center text-gray-500 mt-20">Mulai diskusi Anda di sini...</p>' 
                            : appState.chatMessages.map(msg => `
                                <div class="flex ${msg.user === appState.user.display_name ? 'justify-end' : 'justify-start'}">
                                    <div class="p-3 max-w-xs rounded-lg ${msg.user === appState.user.display_name ? 'bg-indigo-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'} shadow">
                                        <p class="font-bold text-xs ${msg.user === appState.user.display_name ? 'text-indigo-200' : 'text-gray-600'}">${msg.user}</p>
                                        <p class="text-sm whitespace-pre-wrap">${msg.text}</p>
                                        <p class="text-xs text-right mt-1 ${msg.user === appState.user.display_name ? 'text-indigo-300' : 'text-gray-500'}">${new Date(msg.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</p>
                                    </div>
                                </div>
                            `).join('')}
                    </div>

                    <!-- Input Chat -->
                    <div class="flex space-x-2">
                        <input type="text" id="chatInput" class="input-style flex-grow" placeholder="Ketik pesan Anda...">
                        <button onclick="handleChatMessageSend()" class="btn-primary px-6">Kirim</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Handler Chat Lokal (Hanya di memori)
    function handleChatMessageSend() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text) return;

        const newMessage = {
            user: appState.user.display_name,
            text: text,
            timestamp: new Date().toISOString()
        };
        
        // Simpan ke state lokal (seharusnya disimpan ke tabel Supabase 'chat')
        appState.chatMessages.push(newMessage);
        input.value = '';
        
        // Gulir ke bawah setelah pesan dikirim
        render(); 
        const chatBox = document.getElementById('chat-messages');
        if (chatBox) {
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    }


    // --- FUNGSI UTAMA RENDER ---

    function render() {
        const container = document.getElementById('app-container');
        if (!container) return;

        let htmlContent = '';

        if (!appState.isDataLoaded) {
            htmlContent = '<p class="text-center text-xl text-gray-500 py-20">Memuat data dari Supabase...</p>';
        } else if (!appState.user) {
            htmlContent = renderLogin();
        } else {
            switch (appState.currentPage) {
                case 'siswa-home':
                    htmlContent = renderSiswaHome();
                    break;
                case 'siswa-materi':
                    htmlContent = renderSiswaMateri();
                    break;
                case 'siswa-profile':
                    htmlContent = renderSiswaProfile();
                    break;
                case 'guru-home':
                    htmlContent = renderGuruHome();
                    break;
                case 'guru-materi-upload':
                    htmlContent = renderGuruMateriUpload();
                    break;
                case 'admin-home':
                    htmlContent = renderAdminHome();
                    break;
                case 'admin-users':
                    htmlContent = renderAdminUserManagement();
                    break;
                case 'chat':
                    htmlContent = renderChat();
                    break;
                default:
                    htmlContent = renderLogin();
            }
        }

        container.innerHTML = htmlContent;
    }

    // Inisialisasi Aplikasi
    window.onload = () => {
        // Mulai memuat data dari Supabase
        loadInitialData();
        // Setup listener realtime setelah data dimuat
        setupRealtimeListeners();
    };

</script>
</body>
</html>
